# TapDB 迁移和备份

## 通过复制数据文件进行备份

### 使用 AES256-GCM 的加密存储引擎的注意事项

对于使用加密存储引擎加密模式的AES256-GCM， AES256-GCM要求每个进程使用带有密钥的唯一计数器区块值。

对于使用加密存储引擎密码配置的AES256-GCM：

- 从热备份恢复

    从4.2开始，如果从通过“热”备份（即tapdb正在运行）获取的文件中恢复，TapDB 可以在启动时检测“脏”键，并自动滚动数据库键以避免重复使用 IV（初始化向量）。

- 从冷备份恢复

    但是，如果从通过“冷”备份（即tapdb未运行）获取的文件中恢复，则 TapDB 无法在启动时检测到“脏”密钥，并且重复使用 IV 会导致机密性和完整性保证失效。

    从4.2开始，为了避免从冷文件系统快照恢复后重复使用密钥，TapDB 添加了新的命令行选项--eseDatabaseKeyRollover 。使用--eseDatabaseKeyRollover选项启动时， tapdb实例会滚动使用AES256-GCM密码配置的数据库密钥并退出。

### 使用文件系统快照进行备份

您可以通过制作 TapDB 底层数据文件的副本来创建 TapDB 部署的备份。

如果 TapDB 存储数据文件的卷支持时间点快照，您可以使用这些快照创建某个特定时刻的 TapDB 系统备份。文件系统快照是操作系统卷管理器的功能，不是特定于 TapDB 的功能。通过文件系统快照，操作系统可以创建卷的快照，以用作数据备份的基准。快照的机制取决于底层存储系统。例如，在 Linux 上，Logical Volume Manager (LVM) 可以创建快照。同样，Amazon EC2 的 EBS 存储系统也支持快照。

要获得正在运行的tapdb进程的正确快照，必须启用日志功能，并且日志必须与其他 TapDB 数据文件位于同一逻辑卷上。如果未启用日志功能，则无法保证快照的一致性或有效性。

要获得分片集群的一致快照，您必须禁用负载均衡器，并在大约同一时间点从每个分片以及配置服务器捕获快照。

### 使用 cp 或 rsync

如果您的存储系统不支持快照，您可以使用`cp` 、 `rsync`或类似工具直接复制文件。由于复制多个文件不是原子操作，因此必须在复制文件之前停止对tapdb的所有写入。否则，您将复制处于无效状态的文件。

通过复制底层数据生成的备份不支持副本集的时间点恢复，并且难以管理较大的分片集群。此外，这些备份更大，因为它们包括索引和重复的底层存储填充和碎片。相比之下， tapdump创建的备份较小。

## 使用 tapdump

tapdump 从 TapDB 数据库读取数据并创建高保真 BSON 文件，而 taprestore 工具可以使用这些文件来填充 TapDB 数据库。tapdump 和 taprestore 是备份和恢复小型 TapDB 部署的简单而高效的工具，但对于获取大型系统的备份不是理想的工具。

tapdump和taprestore针对正在运行的tapdb进程进行操作，并且可以直接操作底层数据文件。默认情况下， tapdump不捕获本地数据库的内容。

tapdump仅捕获数据库中的文档。生成的备份节省空间，但taprestore或tapdb必须在恢复数据后重建索引。

连接到 TapDB 实例时， tapdump可能会对tapdb性能产生不利影响。如果数据大于系统内存，查询会将工作集挤出内存，从而导致页面错误。

在tapdump捕获输出时，应用程序可以继续修改数据。对于副本集， tapdump提供--oplog选项，以在其输出oplog条目中包含tapdump操作期间出现的条目。这允许相应的taprestore操作重放捕获的 oplog。要恢复使用--oplog创建的备份，请使用taprestore和--oplogReplay选项。

## 使用 TapData

[TapData](https://tapdata.net) 不仅可以满足 TapDB 副本集、分片集的全量和增量备份，更是一个以低延迟数据复制为核心优势构建的实时异构数据集成和数据服务平台。

典型用例包括数据库到数据库的复制、将数据引入数据仓库或数据湖，以及通用 ETL 处理。

